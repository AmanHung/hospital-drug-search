<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>院內電子處方集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen relative flex flex-col">

    <header class="sticky top-0 bg-blue-600 p-4 shadow-md z-20 transition-all duration-300">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-white text-lg font-bold flex items-center cursor-pointer" @click="resetToHome">
                <i class="fa-solid fa-hospital-user mr-2"></i> 藥品查詢系統
            </h1>
            <button v-if="keyword || filterCategory || viewMode !== 'home'" @click="resetToHome" class="text-xs bg-blue-500 hover:bg-blue-400 text-white px-3 py-1 rounded-full transition border border-blue-400">
                <i class="fa-solid fa-rotate-left mr-1"></i> 重置
            </button>
        </div>

        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            <input 
                v-model="keyword" 
                @input="onSearchInput"
                type="text" 
                placeholder="搜尋藥名、學名、代碼..." 
                class="w-full pl-10 pr-10 py-2 rounded-lg border-none focus:ring-2 focus:ring-blue-300 outline-none shadow-inner"
            >
            <button v-if="keyword" @click="keyword=''; onSearchInput()" class="absolute right-3 top-3 text-gray-400">
                <i class="fa-solid fa-times-circle"></i>
            </button>
        </div>

        <div v-if="viewMode === 'home' && !keyword" class="mt-3">
            <button @click="viewMode = 'major_list'" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center transition shadow-sm border border-blue-500">
                <i class="fa-solid fa-layer-group mr-2"></i> 藥理分類查詢
            </button>
        </div>
        
        <div v-if="viewMode === 'result_list' && filterCategory" class="mt-2 text-white text-xs flex items-center overflow-hidden">
            <span class="opacity-70">分類：</span>
            <span class="font-bold truncate ml-1 bg-blue-800 px-2 py-0.5 rounded">{{ currentCategoryName }}</span>
        </div>
    </header>

    <main class="flex-1 p-3 safe-area-bottom overflow-y-auto bg-gray-50">
        
        <div v-if="loading" class="text-center py-20 text-gray-500">
            <div class="loader"></div>
            <p>正在同步資料庫...</p>
        </div>

        <div v-if="error" class="text-center py-20 text-red-500 px-4">
            <i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i>
            <p>{{ error }}</p>
        </div>

        <div v-if="!loading && !error && viewMode === 'home' && !keyword" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <div class="bg-gray-100 p-6 rounded-full mb-4">
                <i class="fa-solid fa-magnifying-glass text-4xl text-gray-300"></i>
            </div>
            <p class="font-bold text-gray-500">請輸入關鍵字搜尋</p>
            <p class="text-sm mt-1">或是點擊上方按鈕依分類瀏覽</p>
        </div>

        <div v-if="viewMode === 'major_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <h3 class="font-bold text-gray-700">藥理主分類</h3>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="cat in atcGroups" :key="cat.code" 
                     @click="selectMajorCategory(cat)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-blue-50 transition">
                    <div class="flex items-center">
                        <span class="font-bold text-gray-800 text-lg">{{ cat.name }}</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'minor_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <button @click="viewMode = 'major_list'" class="text-blue-600 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-arrow-left mr-1"></i> 返回主分類
                </button>
                <span class="text-xs text-gray-500 font-bold">{{ selectedMajor.name }}</span>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="sub in selectedMajor.subs" :key="sub.code" 
                     @click="selectMinorCategory(sub)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-indigo-50 transition">
                    <div class="flex items-center">
                        <span class="text-gray-800 font-medium">{{ sub.name }}</span>
                    </div>
                    <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{{ sub.count }} 筆</span>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'result_list'" class="animate-slide-up">
            <div v-if="filteredDrugs.length === 0" class="text-center py-20 text-gray-400">
                <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                <p>找不到符合條件的藥品</p>
            </div>

            <div 
                v-for="drug in filteredDrugs" 
                :key="drug.code" 
                @click="openDetail(drug)"
                class="bg-white rounded-xl p-3 mb-3 card-shadow border border-gray-100 active:bg-blue-50 transition-colors cursor-pointer relative overflow-hidden"
                :class="{'opacity-60': drug.isDiscontinued}"
            >
                <div class="absolute top-0 right-0 flex">
                    <span v-if="drug.isHighAlert" class="bg-red-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg shadow-sm">高警訊</span>
                    <span v-if="drug.isDiscontinued" class="bg-gray-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">已停用</span>
                    <span v-if="drug.isOutOfStock" class="bg-orange-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">缺貨中</span>
                </div>

                <div class="flex items-start mt-2">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 mr-3 overflow-hidden border flex items-center justify-center">
                        <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                        <i v-else class="fa-solid fa-pills text-gray-300 text-2xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-base leading-tight mb-1 truncate pr-14" :class="drug.isDiscontinued ? 'text-gray-500 line-through' : 'text-blue-800'">
                            {{ drug.tradeName }}
                        </h3>
                        <p class="text-gray-500 text-xs font-mono mb-1 truncate">{{ drug.genericName }}</p>
                        <div v-if="drug.atcSub" class="mb-1">
                             <span class="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded truncate inline-block max-w-full">
                                {{ drug.atcSub }}
                             </span>
                        </div>
                        <p class="text-gray-800 text-xs line-clamp-2 bg-gray-50 p-1 rounded">{{ drug.indication }}</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-0 sm:p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-[85vh] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up">
            
            <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                <h2 class="font-bold text-lg truncate pr-4" :class="selectedDrug.isDiscontinued ? 'text-gray-500 line-through' : 'text-gray-800'">
                    {{ selectedDrug.tradeName }}
                </h2>
                <button @click="closeDetail" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-5">
                <div v-if="selectedDrug.isDiscontinued" class="bg-gray-100 border-l-4 border-gray-500 p-3 rounded text-gray-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-ban mr-2"></i> 此藥品已停用
                </div>
                <div v-else-if="selectedDrug.isOutOfStock" class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded text-orange-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-box-open mr-2"></i> 此藥品目前缺貨中
                </div>

                <div class="w-full bg-white rounded-xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[150px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-64 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-10 flex flex-col items-center">
                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                        <span>無圖片資料</span>
                    </div>
                </div>

                <section v-if="selectedDrug.atcCode" class="bg-indigo-50 rounded-xl p-3 border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-2">藥理分類</h3>
                    <div class="space-y-2">
                        <div v-if="selectedDrug.atcMain" class="flex items-center gap-2 p-1">
                            <span class="bg-indigo-200 text-indigo-800 text-xs px-2 py-0.5 rounded-full font-bold">主分類</span>
                            <span class="text-sm font-bold text-indigo-900">{{ selectedDrug.atcMain }}</span>
                        </div>
                        <div v-if="selectedDrug.atcSub" class="flex items-center gap-2 ml-2 border-l-2 border-indigo-200 pl-2 p-1">
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-bold">子分類</span>
                            <span class="text-sm text-indigo-800">{{ selectedDrug.atcSub }}</span>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 border-b pb-1">基本資料</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><span class="text-xs text-gray-500 block">學名</span><span class="text-gray-900 font-medium select-all">{{ selectedDrug.genericName }}</span></div>
                        <div class="grid grid-cols-2 gap-2">
                             <div><span class="text-xs text-gray-500 block">院內代碼</span><span class="text-gray-900 select-all">{{ selectedDrug.code }}</span></div>
                             <div>
                                <span class="text-xs text-gray-500 block">健保碼 (點擊查價)</span>
                                <a v-if="selectedDrug.nhiCode && selectedDrug.nhiCode !== '-'" href="#" @click.prevent="searchNhiPrice(selectedDrug.nhiCode)" class="text-blue-600 font-bold hover:text-blue-800 underline flex items-center select-all">
                                    {{ selectedDrug.nhiCode }}<i class="fa-solid fa-magnifying-glass-dollar ml-1 text-xs"></i>
                                </a>
                                <span v-else class="text-gray-900">-</span>
                            </div>
                        </div>
                         <div v-if="selectedDrug.components"><span class="text-xs text-gray-500 block">成份</span><span class="text-gray-900 text-sm">{{ selectedDrug.components }}</span></div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-2 border-b border-blue-100 pb-1">臨床用途</h3>
                    <div class="space-y-3">
                        <div><span class="font-bold text-gray-700 text-sm">適應症</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.indication }}</p></div>
                        <div><span class="font-bold text-gray-700 text-sm">用法用量</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.dosage }}</p></div>
                        <div v-if="selectedDrug.renalNote" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><span class="font-bold text-yellow-800 text-sm">劑量調整</span><p class="text-yellow-900 text-sm mt-1">{{ selectedDrug.renalNote }}</p></div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-2 border-b border-green-100 pb-1">衛教資訊</h3>
                    <div class="space-y-3">
                        <div v-if="selectedDrug.sideEffect"><span class="font-bold text-gray-700 text-sm">副作用</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.sideEffect }}</p></div>
                         <div v-if="selectedDrug.patientNote"><span class="font-bold text-gray-700 text-sm">注意事項</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.patientNote }}</p></div>
                    </div>
                </section>
            </div>
            
            <div class="p-3 border-t bg-gray-50 flex gap-2">
                <a v-if="selectedDrug.leafletLink" :href="selectedDrug.leafletLink" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg text-center font-bold text-sm shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-file-pdf mr-2 text-red-500"></i> 仿單
                </a>
                <button @click="closeDetail" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-center font-bold text-sm shadow-md active:bg-blue-700">確定</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // ============== 資料來源設定 ==============
    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const ATC_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMhr-Ocv4uEN6virOvzsEY-c1-tCEs-e1lB-fvB9d2U2XCtcDaHnLnob_Vu6Ktjce4YErY9y6FuaxD/pub?output=csv';
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 
    // ==========================================

    // ATC 中文對照表 (依據要求更新：層級1為1碼，層級2為3碼)
    const ATC_DICT = {
        // Level 1 (大分類) - 1碼
        'A': '消化道及新陳代謝系統',
        'B': '血液及造血器官系統',
        'C': '心血管系統',
        'D': '皮膚科用藥',
        'G': '泌尿生殖系統與性荷爾蒙',
        'H': '全身性荷爾蒙製劑 (不含性荷爾蒙)',
        'J': '全身性抗感染劑',
        'L': '抗腫瘤及免疫調節劑',
        'M': '肌肉骨骼系統',
        'N': '神經系統',
        'P': '抗寄生蟲藥',
        'R': '呼吸系統',
        'S': '感覺器官',
        'V': '其他類',

        // Level 2 (子分類) - 3碼
        'A01': '口腔用藥', 'A02': '制酸劑與抗脹氣藥', 'A03': '功能性胃腸道異常', 'A04': '止吐劑',
        'A05': '膽道與肝臟用藥', 'A06': '便秘用藥', 'A07': '止瀉劑', 'A10': '糖尿病用藥', 'A11': '維生素', 'A12': '礦物質',
        
        'B01': '抗血栓藥', 'B02': '止血藥', 'B03': '抗貧血藥', 'B05': '血液代用劑與輸注液',

        'C01': '心臟治療藥', 'C02': '降血壓藥', 'C03': '利尿劑', 'C04': '周邊血管擴張劑', 
        'C05': '血管保護劑', 'C07': 'β-阻斷劑', 'C08': '鈣離子通道阻斷劑', 'C09': 'ACEI/ARB 系統用藥', 'C10': '降血脂藥',

        'D01': '皮膚抗黴菌藥', 'D02': '保濕劑與保護劑', 'D05': '乾癬用藥', 'D06': '皮膚抗生素與化療藥',
        'D07': '皮膚類固醇', 'D08': '消毒劑', 'D10': '抗痘藥',

        'G01': '婦科抗感染藥', 'G02': '其他婦科用藥', 'G03': '性荷爾蒙', 'G04': '泌尿道用藥',

        'H01': '腦下垂體及下視丘荷爾蒙', 'H02': '全身性皮質類固醇', 'H03': '甲狀腺用藥',

        'J01': '全身性抗菌劑', 'J02': '全身性抗黴菌劑', 'J04': '抗結核病藥', 'J05': '抗病毒藥', 'J06': '免疫血清與球蛋白', 'J07': '疫苗',

        'L01': '抗腫瘤藥', 'L02': '內分泌療法', 'L03': '免疫刺激劑', 'L04': '免疫抑制劑',

        'M01': '抗發炎及抗風濕藥', 'M02': '外用關節肌肉痛藥', 'M03': '肌肉鬆弛劑', 'M04': '抗痛風藥', 'M05': '骨骼疾病治療藥',

        'N01': '麻醉劑', 'N02': '止痛藥', 'N03': '抗癲癇藥', 'N04': '抗巴金森氏症藥', 'N05': '精神安定藥', 'N06': '精神興奮藥', 'N07': '其他神經系統藥',

        'P01': '抗原蟲藥', 'P02': '驅蟲藥',

        'R01': '鼻用製劑', 'R02': '喉部用藥', 'R03': '阻塞性呼吸道疾病', 'R05': '咳嗽與感冒用藥', 'R06': '抗組織胺',

        'S01': '眼科用藥', 'S02': '耳科用藥', 'S03': '眼耳製劑',

        'V03': '解毒劑', 'V04': '診斷用藥', 'V08': '顯影劑', 'V09': '診斷用放射製劑'
    };

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');
            
            // 視圖狀態: home, major_list, minor_list, result_list
            const viewMode = ref('home'); 
            const filterCategory = ref(''); 
            const currentCategoryName = ref('');
            
            const atcGroups = ref([]); 
            const selectedMajor = ref(null); 

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (r) => resolve(r.data), error: (e) => reject(e) });
            });

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([fetchCsv(DRUG_DATA_URL), fetchCsv(ATC_DATA_URL)])
                    .then(([drugData, atcData]) => {
                        const atcMap = {};
                        atcData.forEach(row => {
                            if(row['藥品代碼']) atcMap[row['藥品代碼'].trim()] = row['ATC碼'] ? row['ATC碼'].trim().toUpperCase() : '';
                        });
                        processData(drugData, atcMap);
                        loading.value = false;
                    })
                    .catch(err => {
                        error.value = "資料載入失敗。";
                        loading.value = false;
                    });
            };

            const processData = (rawData, atcMap) => {
                let processed = rawData.map(row => {
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    if(!code) return null;

                    const atc = atcMap[code] || '';
                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                    
                    const status1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const status2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    let isDiscontinued = (status1 === 'Y' || status2 === 'Y') && !(status1 === 'N' || status2 === 'N');
                    let isOutOfStock = (status1 === 'C' || status2 === 'C') && !isDiscontinued && !(status1 === 'N' || status2 === 'N');

                    // ATC Parsing: 第1層=1碼, 第2層=3碼
                    let atcMain = '', atcSub = '';
                    if (atc.length >= 1) {
                        const c1 = atc.substring(0, 1);
                        atcMain = ATC_DICT[c1] || `分類 ${c1}`; 
                    }
                    if (atc.length >= 3) {
                        const c3 = atc.substring(0, 3);
                        atcSub = ATC_DICT[c3] || c3; 
                    }

                    return {
                        code, nhiCode: row['健保碼']||'-', genericName: row['學名']||'', tradeName: row['商品名(英文)']||row['商品名']||'無商品名',
                        indication: row['適應症']||row['臨床用途']||'', dosage: row['用量用法']||'', sideEffect: row['副作用']||'',
                        patientNote: row['民眾注意事項']||row['警語']||'', renalNote: row['劑量調整']||'', components: row['藥品成分']||'',
                        pregCategory: row['懷孕分級']||'', highAlert: row['高警訊藥品'], 
                        isHighAlert: (row['高警訊藥品'] === 'Y'), isDiscontinued, isOutOfStock,
                        imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                        leafletLink: row['超連結']||'', atcCode: atc, atcMain, atcMainCode: atc.substring(0,1), atcSub, atcSubCode: atc.substring(0,3)
                    };
                }).filter(d => d !== null);

                drugs.value = processed;
                buildAtcTree(processed);
            };

            const buildAtcTree = (data) => {
                const groups = {}; 

                data.forEach(d => {
                    // 只建立有資料的分類
                    if (d.atcMainCode && d.atcMain) {
                        // Level 1: 1 char
                        if (!groups[d.atcMainCode]) {
                            groups[d.atcMainCode] = { code: d.atcMainCode, name: d.atcMain, subs: {} };
                        }
                        // Level 2: 3 chars
                        if (d.atcSubCode && d.atcSub) {
                            if (!groups[d.atcMainCode].subs[d.atcSubCode]) {
                                groups[d.atcMainCode].subs[d.atcSubCode] = { code: d.atcSubCode, name: d.atcSub, count: 0 };
                            }
                            groups[d.atcMainCode].subs[d.atcSubCode].count++;
                        }
                    }
                });

                atcGroups.value = Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
            };

            const filteredDrugs = computed(() => {
                let result = [];
                
                if (keyword.value) {
                    const k = keyword.value.toLowerCase().trim();
                    result = drugs.value.filter(d => 
                        (d.tradeName && d.tradeName.toLowerCase().includes(k)) ||
                        (d.genericName && d.genericName.toLowerCase().includes(k)) ||
                        (d.code && d.code.toLowerCase().includes(k)) ||
                        (d.indication && d.indication.toLowerCase().includes(k)) ||
                        (d.atcCode && d.atcCode.toLowerCase().includes(k))
                    );
                } 
                else if (filterCategory.value) {
                    // 比對前3碼
                    result = drugs.value.filter(d => d.atcCode.startsWith(filterCategory.value));
                }
                else {
                    return [];
                }

                return result.sort((a, b) => {
                    const getScore = (drug) => {
                        if (drug.isDiscontinued) return 3;
                        if (drug.isOutOfStock) return 2;
                        return 1;
                    };
                    return getScore(a) - getScore(b);
                });
            });

            const onSearchInput = () => {
                if(keyword.value) {
                    viewMode.value = 'result_list';
                    filterCategory.value = ''; 
                } else {
                    viewMode.value = 'home';
                }
            };

            const selectMajorCategory = (cat) => {
                selectedMajor.value = { ...cat, subs: Object.values(cat.subs).sort((a,b) => a.code.localeCompare(b.code)) };
                viewMode.value = 'minor_list';
            };

            const selectMinorCategory = (sub) => {
                filterCategory.value = sub.code;
                currentCategoryName.value = sub.name;
                viewMode.value = 'result_list';
            };

            const resetToHome = () => {
                keyword.value = '';
                filterCategory.value = '';
                viewMode.value = 'home';
            };

            const searchNhiPrice = (code) => {
                navigator.clipboard.writeText(code).then(() => {
                    if(confirm(`健保碼 ${code} 已複製！前往健保署網站？`)) window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank');
                }).catch(() => window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank'));
            };

            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 

            onMounted(() => { fetchAllData(); });

            return {
                keyword, filteredDrugs, selectedDrug, loading, error, 
                viewMode, atcGroups, selectedMajor, filterCategory, currentCategoryName,
                onSearchInput, selectMajorCategory, selectMinorCategory, resetToHome,
                openDetail, closeDetail, imageLoadError, searchNhiPrice
            };
        }
    }).mount('#app');
</script>
</body>
</html>
