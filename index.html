<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>院內電子處方集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen relative flex flex-col">

    <header class="sticky top-0 bg-blue-600 p-4 shadow-md z-20">
        <h1 class="text-white text-lg font-bold mb-2 flex items-center">
            <i class="fa-solid fa-hospital-user mr-2"></i> 藥品查詢系統
        </h1>
        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            <input 
                v-model="keyword" 
                type="text" 
                placeholder="搜尋藥名、學名、代碼、適應症..." 
                class="w-full pl-10 pr-10 py-2 rounded-lg border-none focus:ring-2 focus:ring-blue-300 outline-none shadow-inner"
            >
            <button v-if="keyword" @click="keyword=''" class="absolute right-3 top-3 text-gray-400">
                <i class="fa-solid fa-times-circle"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 p-3 safe-area-bottom overflow-y-auto bg-gray-50">
        
        <div v-if="loading" class="text-center py-10 text-gray-500">
            <div class="loader"></div>
            <p>正在同步處方集資料...</p>
        </div>

        <div v-if="error" class="text-center py-10 text-red-500 px-4">
            <i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i>
            <p>{{ error }}</p>
            <p class="text-xs text-gray-400 mt-2">請確認 Google Sheet 已發布為 CSV</p>
        </div>

        <div v-else-if="!loading && filteredDrugs.length === 0" class="text-center py-10 text-gray-400">
            <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
            <p>找不到符合「{{ keyword }}」的藥品</p>
        </div>

        <div 
            v-for="drug in filteredDrugs" 
            :key="drug.code" 
            @click="openDetail(drug)"
            class="bg-white rounded-xl p-3 mb-3 card-shadow border border-gray-100 active:bg-blue-50 transition-colors cursor-pointer relative overflow-hidden"
            :class="{'opacity-60': drug.isDiscontinued}"
        >
            <div class="absolute top-0 right-0 flex">
                <span v-if="drug.isHighAlert" class="bg-red-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg shadow-sm">
                    高警訊
                </span>
                <span v-if="drug.isDiscontinued" class="bg-gray-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">
                    已停用
                </span>
                <span v-if="drug.isOutOfStock" class="bg-orange-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">
                    缺貨中
                </span>
            </div>

            <div class="flex items-start mt-2">
                <div class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 mr-3 overflow-hidden border flex items-center justify-center">
                    <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                    <i v-else class="fa-solid fa-pills text-gray-300 text-2xl"></i>
                </div>

                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-base leading-tight mb-1 truncate pr-14" 
                        :class="drug.isDiscontinued ? 'text-gray-500 line-through' : 'text-blue-800'">
                        {{ drug.tradeName }}
                    </h3>
                    <p class="text-gray-500 text-xs font-mono mb-1 truncate">{{ drug.genericName }}</p>
                    <p class="text-gray-800 text-xs line-clamp-2 bg-gray-50 p-1 rounded">{{ drug.indication }}</p>
                    
                    <div class="mt-2 flex flex-wrap gap-1">
                        <span class="bg-blue-50 text-blue-600 text-[10px] px-1.5 py-0.5 rounded border border-blue-100">
                            {{ drug.code }}
                        </span>
                         <span v-if="drug.pregCategory" class="bg-pink-50 text-pink-600 text-[10px] px-1.5 py-0.5 rounded border border-pink-100">
                            懷孕: {{ drug.pregCategory }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-0 sm:p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-[85vh] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up">
            
            <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                <h2 class="font-bold text-lg truncate pr-4"
                    :class="selectedDrug.isDiscontinued ? 'text-gray-500 line-through' : 'text-gray-800'">
                    {{ selectedDrug.tradeName }}
                </h2>
                <button @click="closeDetail" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-5">
                <div v-if="selectedDrug.isDiscontinued" class="bg-gray-100 border-l-4 border-gray-500 p-3 rounded text-gray-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-ban mr-2"></i> 此藥品已停用
                </div>
                <div v-else-if="selectedDrug.isOutOfStock" class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded text-orange-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-box-open mr-2"></i> 此藥品目前缺貨中
                </div>

                <div class="w-full bg-white rounded-xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[150px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-64 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-10 flex flex-col items-center">
                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                        <span>無圖片資料</span>
                    </div>
                </div>

                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 border-b pb-1">基本資料</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <span class="text-xs text-gray-500 block">學名</span>
                            <span class="text-gray-900 font-medium select-all">{{ selectedDrug.genericName }}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <span class="text-xs text-gray-500 block">院內代碼</span>
                                <span class="text-gray-900 select-all">{{ selectedDrug.code }}</span>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block">健保碼</span>
                                <span class="text-gray-900 select-all">{{ selectedDrug.nhiCode }}</span>
                            </div>
                        </div>
                         <div v-if="selectedDrug.components">
                            <span class="text-xs text-gray-500 block">成份</span>
                            <span class="text-gray-900 text-sm">{{ selectedDrug.components }}</span>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-2 border-b border-blue-100 pb-1">臨床用途</h3>
                    <div class="space-y-3">
                        <div>
                            <span class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-bullseye mr-1"></i>適應症</span>
                            <p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.indication }}</p>
                        </div>
                        <div>
                            <span class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-prescription-bottle-medical mr-1"></i>用法用量</span>
                            <p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.dosage }}</p>
                        </div>
                        <div v-if="selectedDrug.renalNote" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                            <span class="font-bold text-yellow-800 text-sm"><i class="fa-solid fa-kidney mr-1"></i>劑量調整</span>
                            <p class="text-yellow-900 text-sm mt-1">{{ selectedDrug.renalNote }}</p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-2 border-b border-green-100 pb-1">衛教資訊</h3>
                    <div class="space-y-3">
                        <div v-if="selectedDrug.sideEffect">
                            <span class="font-bold text-gray-700 text-sm">副作用</span>
                            <p class="text-gray-600 text-sm mt-1">{{ selectedDrug.sideEffect }}</p>
                        </div>
                         <div v-if="selectedDrug.patientNote">
                            <span class="font-bold text-gray-700 text-sm">注意事項</span>
                            <p class="text-gray-600 text-sm mt-1">{{ selectedDrug.patientNote }}</p>
                        </div>
                    </div>
                </section>
            </div>
            
            <div class="p-3 border-t bg-gray-50 flex gap-2">
                <a v-if="selectedDrug.leafletLink" :href="selectedDrug.leafletLink" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg text-center font-bold text-sm shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-file-pdf mr-2 text-red-500"></i> 仿單
                </a>
                <button @click="closeDetail" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-center font-bold text-sm shadow-md active:bg-blue-700">
                    確定
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // ============== 設定資料來源 ==============
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 
    // ==========================================

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');
            
            // 讀取 Google Sheet CSV
            const fetchDrugs = () => {
                loading.value = true;
                Papa.parse(GOOGLE_SHEET_CSV_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        console.log("資料讀取成功，第一筆資料:", results.data[0]);
                        if (results.data && results.data.length > 0) {
                            processData(results.data);
                        } else {
                            error.value = "讀取到的資料為空，請檢查 Google Sheet 內容。";
                        }
                        loading.value = false;
                    },
                    error: (err) => {
                        console.error("CSV 讀取失敗", err);
                        error.value = "無法讀取處方集資料，請檢查網路或連結設定。";
                        loading.value = false;
                    }
                });
            };

            // 資料處理與欄位對應
            const processData = (rawData) => {
                drugs.value = rawData.map(row => {
                    // 根據 CSV 欄位名稱進行對應
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                    
                    // 圖片連結處理 (Cloudinary)
                    let imgUrl = null;
                    if (imgName) {
                        imgUrl = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}`;
                    }

                    // 狀態判斷邏輯
                    const s1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const s2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    
                    let isDiscontinued = false;
                    let isOutOfStock = false;
                    
                    // 邏輯 1: 只要有一欄位有 N -> 呈現「使用中」(正常)
                    if (s1 === 'N' || s2 === 'N') {
                        // 視為正常，不做任何標記
                        isDiscontinued = false;
                        isOutOfStock = false;
                    } 
                    // 邏輯 2: 如果同時出現 Y 和 C (或兩者皆 Y) -> 呈現「已停用」
                    // 這裡的邏輯是：在沒有 N 的情況下，只要有 Y，就視為停用
                    else if (s1 === 'Y' || s2 === 'Y') {
                        isDiscontinued = true;
                    } 
                    // 邏輯 3: 剩下就是兩者皆 C (或 C 配空值) -> 呈現「缺貨中」
                    else if (s1 === 'C' || s2 === 'C') {
                        isOutOfStock = true;
                    }

                    return {
                        code: code,
                        nhiCode: row['健保碼'] || '-',
                        genericName: row['學名'] || '',
                        tradeName: row['商品名(英文)'] || row['商品名'] || '無商品名',
                        indication: row['適應症'] || row['臨床用途'] || '',
                        dosage: row['用量用法'] || '',
                        sideEffect: row['副作用'] || '',
                        patientNote: row['民眾注意事項'] || row['警語'] || '',
                        renalNote: row['劑量調整'] || '',
                        components: row['藥品成分'] || '',
                        pregCategory: row['懷孕分級'] || '',
                        highAlert: row['高警訊藥品'], 
                        isHighAlert: (row['高警訊藥品'] && row['高警訊藥品'].trim().toUpperCase() === 'Y'),
                        isDiscontinued: isDiscontinued,
                        isOutOfStock: isOutOfStock,
                        imgUrl: imgUrl,
                        leafletLink: row['超連結'] || ''
                    };
                }).filter(d => d.code); // 過濾掉沒有代碼的空行
            };

            // 搜尋與排序邏輯
            const filteredDrugs = computed(() => {
                let result = drugs.value;

                // 1. 先過濾關鍵字
                if (keyword.value) {
                    const k = keyword.value.toLowerCase().trim();
                    result = result.filter(d => 
                        (d.tradeName && d.tradeName.toLowerCase().includes(k)) ||
                        (d.genericName && d.genericName.toLowerCase().includes(k)) ||
                        (d.code && d.code.toLowerCase().includes(k)) ||
                        (d.indication && d.indication.toLowerCase().includes(k))
                    );
                }

                // 2. 再進行排序 (正常 -> 缺貨 -> 停用)
                // 權重：正常=1, 缺貨=2, 停用=3 (數字越小越前面)
                return result.sort((a, b) => {
                    const getScore = (drug) => {
                        if (drug.isDiscontinued) return 3; // 停用放最後
                        if (drug.isOutOfStock) return 2;   // 缺貨放中間
                        return 1;                          // 正常放最前
                    };
                    return getScore(a) - getScore(b);
                });
            });

            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 

            onMounted(() => {
                fetchDrugs();
            });

            return {
                keyword,
                filteredDrugs,
                selectedDrug,
                loading,
                error,
                openDetail,
                closeDetail,
                imageLoadError
            };
        }
    }).mount('#app');
</script>
</body>
</html>
