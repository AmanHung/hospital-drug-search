<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>院內電子處方集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .error-modal { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90%; text-align: center; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen relative flex flex-col">

    <div v-if="error" class="error-modal">
        <p class="font-bold mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 系統訊息</p>
        <p class="text-sm">{{ error }}</p>
        <button @click="error = ''" class="mt-2 text-xs bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded border border-red-300">關閉</button>
    </div>

    <header class="sticky top-0 bg-blue-600 p-4 shadow-md z-30">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-white text-lg font-bold flex items-center cursor-pointer" @click="resetToHome">
                <i class="fa-solid fa-hospital-user mr-2"></i> 衛生福利部豐原醫院藥品查詢系統
            </h1>
            <button v-if="keyword || filterCategory || viewMode !== 'home'" @click="resetToHome" class="text-xs bg-blue-500 hover:bg-blue-400 text-white px-3 py-1 rounded-full transition border border-blue-400">
                <i class="fa-solid fa-rotate-left mr-1"></i> 重置
            </button>
        </div>

        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            <input 
                v-model="keyword" 
                @input="onSearchInput"
                type="text" 
                placeholder="搜尋藥名、學名、代碼、副作用..." 
                class="w-full pl-10 pr-10 py-2 rounded-lg border-none focus:ring-2 focus:ring-blue-300 outline-none shadow-inner"
            >
            <button v-if="keyword" @click="keyword=''; onSearchInput()" class="absolute right-3 top-3 text-gray-400">
                <i class="fa-solid fa-times-circle"></i>
            </button>
        </div>

        <div v-if="viewMode === 'home' && !keyword" class="mt-3">
            <button @click="viewMode = 'major_list'" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center transition shadow-sm border border-blue-500">
                <i class="fa-solid fa-layer-group mr-2"></i> 藥理分類查詢
            </button>
        </div>
    </header>

    <main class="flex-1 p-3 safe-area-bottom overflow-y-auto bg-gray-50">
        
        <div v-if="loading" class="text-center py-20 text-gray-500">
            <div class="loader"></div>
            <p>正在同步資料庫...</p>
            <p class="text-xs mt-2 text-gray-400">載入 ATC 字典中...</p>
        </div>

        <div v-if="!loading && viewMode === 'home' && !keyword" class="py-4">
            <div v-if="outOfStockDrugs.length > 0" class="animate-slide-up">
                <div class="bg-orange-50 border border-orange-200 rounded-xl overflow-hidden shadow-sm mx-1">
                    <div class="bg-orange-100 px-4 py-3 border-b border-orange-200 flex justify-between items-center">
                        <h3 class="text-orange-800 font-bold flex items-center">
                            <i class="fa-solid fa-bullhorn mr-2"></i> 缺貨公告
                        </h3>
                        <span class="bg-orange-200 text-orange-900 text-xs px-2 py-0.5 rounded-full font-bold">
                            共 {{ outOfStockDrugs.length }} 品項
                        </span>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto p-2"> 
                        <div v-for="drug in outOfStockDrugs" :key="drug.code" @click="openDetail(drug)" class="bg-white p-3 mb-2 rounded-lg border border-orange-100 shadow-sm flex items-center cursor-pointer hover:bg-orange-50 transition">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center mb-1">
                                    <span class="bg-gray-600 text-white text-[10px] px-1.5 py-0.5 rounded mr-2 font-mono">{{ drug.code }}</span>
                                    <h4 class="font-bold text-gray-800 truncate text-sm">{{ drug.tradeName }}</h4>
                                </div>
                                <p class="text-gray-500 text-xs truncate pl-1">{{ drug.genericName }}</p>
                            </div>
                            <i class="fa-solid fa-chevron-right text-orange-300 text-xs ml-2"></i>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6 text-gray-400 text-sm"><p>或是輸入關鍵字進行查詢</p></div>
            </div>
            <div v-else class="flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="bg-gray-100 p-6 rounded-full mb-4"><i class="fa-solid fa-magnifying-glass text-4xl text-gray-300"></i></div>
                <p class="font-bold text-gray-500">目前無缺貨藥品</p>
                <p class="text-sm mt-1">請輸入關鍵字搜尋</p>
                <p class="text-sm mt-1">或是點擊上方按鈕依分類瀏覽</p>
            </div>
        </div>

        <div v-if="viewMode === 'major_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1"><h3 class="font-bold text-gray-700">藥理主分類</h3></div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="cat in atcGroups" :key="cat.code" @click="selectMajorCategory(cat)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-blue-50 transition">
                    <div class="flex items-center"><span class="font-bold text-gray-800 text-lg">{{ cat.name }}</span></div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'minor_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <button @click="viewMode = 'major_list'" class="text-blue-600 text-sm font-bold flex items-center"><i class="fa-solid fa-arrow-left mr-1"></i> 返回主分類</button>
                <span class="text-xs text-gray-500 font-bold">{{ selectedMajor.name }}</span>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="sub in selectedMajor.subs" :key="sub.code" @click="selectMinorCategory(sub)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-indigo-50 transition">
                    <div class="flex items-center"><span class="text-gray-800 font-medium">{{ sub.name }}</span></div>
                    <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{{ sub.count }} 筆</span>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'sub_minor_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <button @click="viewMode = 'minor_list'" class="text-blue-600 text-sm font-bold flex items-center"><i class="fa-solid fa-arrow-left mr-1"></i> 返回子分類</button>
                <span class="text-xs text-gray-500 font-bold">{{ selectedMinor.name }}</span>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="subsub in selectedMinor.subsubs" :key="subsub.code" @click="selectSubMinorCategory(subsub)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-green-50 transition">
                    <div class="flex items-center"><span class="text-gray-800 font-medium">{{ subsub.name }}</span></div>
                    <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{{ subsub.count }} 筆</span>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'result_list'" class="animate-slide-up">
            <div v-if="filterCategory" class="flex items-center justify-between mb-3 px-1 sticky top-0 bg-gray-50 z-10 py-2">
                <button @click="backToMinorList" class="text-blue-600 text-sm font-bold flex items-center"><i class="fa-solid fa-arrow-left mr-1"></i> 返回分類列表</button>
                <span class="text-xs text-gray-500 font-bold bg-white px-2 py-1 rounded shadow-sm border">{{ currentCategoryName }}</span>
            </div>
            <div v-if="groupedDrugs.length === 0" class="text-center py-20 text-gray-400">
                <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                <p>找不到符合條件的藥品</p>
            </div>

            <div v-for="group in groupedDrugs" :key="group.code" class="mb-4">
                <div v-if="filterCategory" class="relative bg-gray-100 border-l-4 border-blue-500 px-3 py-2 text-sm font-bold text-gray-700 shadow-sm flex items-center mb-2 rounded-r">
                    <span class="bg-gray-600 text-white text-[10px] px-1.5 py-0.5 rounded mr-2 font-mono">{{ group.code }}</span>
                    <span>{{ group.name }}</span>
                </div>
                <div v-else class="px-2 mb-2 text-gray-500 text-xs font-bold">{{ group.name }}</div>

               <div v-for="drug in group.drugs" :key="drug.code" @click="openDetail(drug)" class="bg-white rounded-xl p-3 mb-3 card-shadow border border-gray-100 active:bg-blue-50 transition-colors cursor-pointer relative overflow-hidden" :class="{'opacity-60': drug.isDiscontinued}">
                    <div v-if="drug.atcSubSub" class="absolute top-0 left-0 z-10">
                        <span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 font-bold rounded-br-lg shadow-sm border-r border-b border-blue-100">{{ drug.atcSubSub }}</span>
                    </div>
                    <div class="absolute top-0 right-0 flex z-10">
                        <span v-if="drug.isSelfPay" class="bg-green-600 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">自費</span>
                        <span v-if="drug.isDiscontinued" class="bg-gray-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">已停用</span>
                        <span v-if="drug.isOutOfStock" class="bg-orange-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">缺貨中</span>
                    </div>
                    <div class="flex items-start mt-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 mr-3 overflow-hidden border flex items-center justify-center">
                            <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                            <i v-else class="fa-solid fa-pills text-gray-300 text-2xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-base leading-tight mb-1 truncate pr-2" :class="drug.isDiscontinued ? 'text-gray-500 line-through' : 'text-blue-800'">{{ drug.tradeName }}</h3>
                            <p class="text-gray-500 text-xs font-mono mb-1 truncate">{{ drug.genericName }}</p>
                            <p class="text-gray-800 text-xs line-clamp-2 bg-gray-50 p-1 rounded">{{ drug.indication }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-0 sm:p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-[85vh] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up">
            <div class="flex justify-between items-start p-3 border-b bg-gray-50">
                <div class="flex-1 pr-2 min-w-0">
                    <div v-if="selectedDrug.isHighAlert" class="mb-1">
                         <span class="bg-red-500 text-white text-[10px] px-2 py-0.5 font-bold rounded shadow-sm inline-flex items-center"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 高警訊藥品</span>
                    </div>
                    <h2 class="font-bold text-lg leading-tight break-words" :class="selectedDrug.isDiscontinued ? 'text-gray-500 line-through' : 'text-gray-800'">{{ selectedDrug.tradeName }}</h2>
                </div>
                <button @click="closeDetail" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition flex-shrink-0 mt-1"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-5">
                <div v-if="selectedDrug.isDiscontinued" class="bg-gray-100 border-l-4 border-gray-500 p-3 rounded text-gray-700 text-sm font-bold flex items-center"><i class="fa-solid fa-ban mr-2"></i> 此藥品已停用</div>
                <div v-else-if="selectedDrug.isOutOfStock" class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded text-orange-700 text-sm font-bold flex items-center"><i class="fa-solid fa-box-open mr-2"></i> 此藥品目前缺貨中</div>

                <div class="w-full bg-white rounded-xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[150px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-64 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-10 flex flex-col items-center"><i class="fa-solid fa-image text-4xl mb-2"></i><span>無圖片資料</span></div>
                </div>

                <section v-if="selectedDrug.atcCode" class="bg-indigo-50 rounded-xl p-3 border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-2">藥理分類 (點擊跳轉)</h3>
                    <div class="space-y-2">
                        <div v-if="selectedDrug.atcMain" 
                             @click="goToCategory('main', selectedDrug)"
                             class="flex items-center gap-2 p-1.5 rounded hover:bg-white hover:shadow-sm cursor-pointer transition group">
                            <span class="bg-indigo-200 text-indigo-800 text-xs px-2 py-0.5 rounded-full font-bold group-hover:bg-indigo-600 group-hover:text-white transition">主分類</span>
                            <span class="text-sm font-bold text-indigo-900 group-hover:text-indigo-700 flex-1">
                                {{ selectedDrug.atcMain }}
                            </span>
                            <i class="fa-solid fa-turn-up text-indigo-300 group-hover:text-indigo-500 text-xs"></i>
                        </div>

                        <div v-if="selectedDrug.atcSub" 
                             @click="goToCategory('sub', selectedDrug)"
                             class="flex items-center gap-2 ml-2 border-l-2 border-indigo-200 pl-2 p-1.5 rounded hover:bg-white hover:shadow-sm cursor-pointer transition group">
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-bold group-hover:bg-indigo-500 group-hover:text-white transition">子分類</span>
                            <span class="text-sm text-indigo-800 group-hover:text-indigo-700 flex-1">
                                {{ selectedDrug.atcSub }}
                            </span>
                            <i class="fa-solid fa-folder-open text-indigo-300 group-hover:text-indigo-500 text-xs"></i>
                        </div>

                        <div v-if="selectedDrug.atcSubSub" 
                             @click="goToCategory('subsub', selectedDrug)"
                             class="flex items-center gap-2 ml-4 border-l-2 border-green-200 pl-2 p-1.5 rounded hover:bg-green-50 hover:shadow-sm cursor-pointer transition group">
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-bold group-hover:bg-green-600 group-hover:text-white transition">細分類</span>
                            <span class="text-sm text-green-800 group-hover:text-green-700 flex-1">
                                {{ selectedDrug.atcSubSub }}
                            </span>
                            <i class="fa-solid fa-filter text-green-300 group-hover:text-green-600 text-xs"></i>
                        </div>
                    </div>
                </section>

               <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 border-b pb-1">基本資料</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><span class="text-xs text-gray-500 block">學名</span><span class="text-gray-900 font-medium select-all">{{ selectedDrug.genericName }}</span></div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <span class="text-xs text-gray-500 block">院內代碼</span><span class="text-gray-900 select-all">{{ selectedDrug.code }}</span>
                                <div v-if="(selectedDrug.isDiscontinued || selectedDrug.isOutOfStock) && (selectedDrug.sub1 || selectedDrug.sub2)" class="mt-2">
                                    <span class="text-[10px] text-red-500 font-bold block mb-1"><i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> 建議替代品項</span>
                                    <div class="flex flex-wrap gap-1">
                                        <button v-if="selectedDrug.sub1" @click="openSubstitute(selectedDrug.sub1)" class="bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 text-xs px-2 py-1 rounded transition flex items-center">{{ selectedDrug.sub1 }} <i class="fa-solid fa-external-link-alt ml-1 text-[10px]"></i></button>
                                        <button v-if="selectedDrug.sub2" @click="openSubstitute(selectedDrug.sub2)" class="bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 text-xs px-2 py-1 rounded transition flex items-center">{{ selectedDrug.sub2 }} <i class="fa-solid fa-external-link-alt ml-1 text-[10px]"></i></button>
                                    </div>
                                </div>
                             </div>
                             <div>
                                <div class="mb-2">
                                    <span class="text-xs text-gray-500 block">健保碼 (點擊查價)</span>
                                    <a v-if="selectedDrug.nhiCode && selectedDrug.nhiCode !== '-'" href="#" @click.prevent="searchNhiPrice(selectedDrug.nhiCode)" class="text-blue-600 font-bold hover:text-blue-800 underline flex items-center select-all">{{ selectedDrug.nhiCode }}<i class="fa-solid fa-magnifying-glass-dollar ml-1 text-xs"></i></a>
                                    <span v-else class="text-gray-900">-</span>
                                </div>
                                <div v-if="selectedDrug.selfPayPrice"><span class="text-xs text-gray-500 block">自費價</span><span class="text-red-600 font-bold font-mono text-base">{{ selectedDrug.selfPayPrice }}</span></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section v-if="selectedDrug.orderNote" class="bg-yellow-50 rounded-xl p-3 border border-yellow-200">
                    <h3 class="text-xs font-bold text-yellow-700 uppercase tracking-wider mb-2 flex items-center">
                        <i class="fa-solid fa-clipboard-check mr-1.5"></i> 醫令提示訊息
                    </h3>
                    <div class="text-sm text-yellow-900 font-medium leading-relaxed whitespace-pre-line">
                        {{ selectedDrug.orderNote }}
                    </div>
                </section>
                
                <section>
                    <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-2 border-b border-blue-100 pb-1">臨床用途</h3>
                    <div class="space-y-3">
                        <div><span class="font-bold text-gray-700 text-sm">適應症</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.indication }}</p></div>
                        <div><span class="font-bold text-gray-700 text-sm">用法用量</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.dosage }}</p></div>
                        <div v-if="selectedDrug.renalNote" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><span class="font-bold text-yellow-800 text-sm">劑量調整</span><p class="text-yellow-900 text-sm mt-1">{{ selectedDrug.renalNote }}</p></div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-2 border-b border-green-100 pb-1">衛教資訊</h3>
                    <div class="space-y-3">
                        <div v-if="selectedDrug.sideEffect"><span class="font-bold text-gray-700 text-sm">副作用</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.sideEffect }}</p></div>
                        
                        <div v-if="selectedDrug.contraindication">
                            <span class="font-bold text-red-800 text-sm"><i class="fa-solid fa-ban mr-1"></i>禁忌</span>
                            <p class="text-red-900 text-sm mt-1 font-bold">{{ selectedDrug.contraindication }}</p>
                        </div>
                        
                        <div v-if="selectedDrug.pregCategory">
                            <span class="font-bold text-gray-700 text-sm block mb-1">懷孕分級</span>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">{{ selectedDrug.pregCategory }}</span>
                        </div>

                        <div v-if="selectedDrug.warning">
                            <span class="font-bold text-red-600 text-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i>警語</span>
                            <p class="text-red-700 text-sm mt-1 font-bold">{{ selectedDrug.warning }}</p>
                        </div>

                        <div v-if="selectedDrug.warningEng">
                            <span class="font-bold text-gray-700 text-sm">警語 (英文)</span>
                            <p class="text-gray-600 text-sm mt-1">{{ selectedDrug.warningEng }}</p>
                        </div>

                        <div v-if="selectedDrug.precautionEng">
                            <span class="font-bold text-gray-700 text-sm">藥品注意事項 (英文)</span>
                            <p class="text-gray-600 text-sm mt-1">{{ selectedDrug.precautionEng }}</p>
                        </div>

                        <div v-if="selectedDrug.profNote">
                            <span class="font-bold text-purple-700 text-sm"><i class="fa-solid fa-user-doctor mr-1"></i>醫護用藥須知</span>
                            <p class="text-gray-700 text-sm mt-1">{{ selectedDrug.profNote }}</p>
                        </div>
                        <div v-if="selectedDrug.patientNote"><span class="font-bold text-gray-700 text-sm">民眾注意事項</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.patientNote }}</p></div>
                    </div>
                </section>
            </div>
            
            <div class="p-3 border-t bg-gray-50 flex gap-2">
                <a v-if="selectedDrug.leafletLink" :href="selectedDrug.leafletLink" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg text-center font-bold text-sm shadow-sm flex items-center justify-center"><i class="fa-solid fa-file-pdf mr-2 text-red-500"></i> 仿單</a>
                <button @click="closeDetail" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-center font-bold text-sm shadow-md active:bg-blue-700">確定</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // ============== 資料來源 ==============
    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const ATC_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMhr-Ocv4uEN6virOvzsEY-c1-tCEs-e1lB-fvB9d2U2XCtcDaHnLnob_Vu6Ktjce4YErY9y6FuaxD/pub?output=csv';
    const ATC_DICT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFu4K84SNNwPkybX9AD49PxAsj5VLa_cO4lmZNAZdK0BFY7qTL0wlFoDKvrcVmBmbcqYiTzvs9wrDj/pub?output=csv';
    
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');
            
            const viewMode = ref('home'); 
            const filterCategory = ref(''); 
            const currentCategoryName = ref('');
            
            const atcGroups = ref([]); 
            const selectedMajor = ref(null); 
            const selectedMinor = ref(null);

            // === Fuse.js 設定 (模糊搜尋) ===
            let fuse = null;
            const fuseOptions = {
                keys: [
                    { name: 'code', weight: 0.1 },        
                    { name: 'tradeName', weight: 0.3 },   
                    { name: 'genericName', weight: 0.3 }, 
                    { name: 'nhiCode', weight: 0.2 },     
                    { name: 'atcCode', weight: 0.1 },     
                    { name: 'indication', weight: 0.1 },  
                    { name: 'sideEffect', weight: 0.1 },  
                    { name: 'warning', weight: 0.1 },     
                    { name: 'contraindication', weight: 0.1 },
                    { name: 'patientNote', weight: 0.1 }
                ],
                threshold: 0.3,       
                ignoreLocation: true,
                useExtendedSearch: true
            };

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (r) => resolve(r.data), error: (e) => reject(e) });
            });

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([
                    fetchCsv(DRUG_DATA_URL), 
                    fetchCsv(ATC_DATA_URL),
                    fetchCsv(ATC_DICT_URL)
                ])
                .then(([drugData, atcData, atcDictData]) => {
                    const atcMap = {};
                    atcData.forEach(row => {
                        if(row['藥品代碼']) {
                            atcMap[row['藥品代碼'].trim()] = {
                                atc: row['ATC碼'] ? row['ATC碼'].trim().toUpperCase() : '',
                                price: row['自費價'] ? row['自費價'].trim() : '',
                                sub1: row['替代院內代碼1'] ? row['替代院內代碼1'].trim() : '',
                                sub2: row['替代院內代碼2'] ? row['替代院內代碼2'].trim() : '',
                                orderNote: row['醫令提示訊息'] ? row['醫令提示訊息'].trim() : '' 
                            };
                        }
                    });

                    const dictionary = {};
                    if (atcDictData && atcDictData.length > 0) {
                        const headers = Object.keys(atcDictData[0]);
                        const codeKey = headers.find(h => /code|代碼|atc/i.test(h));
                        const nameKey = headers.find(h => /name|名稱|中文|chinese/i.test(h));

                        if (codeKey && nameKey) {
                            atcDictData.forEach(row => {
                                const code = row[codeKey];
                                const name = row[nameKey];
                                if(code && name) {
                                    dictionary[code.trim()] = name.trim();
                                }
                            });
                        } else {
                            atcDictData.forEach(row => {
                                const c = row['code'] || row['Code'] || row['ATC代碼'];
                                const n = row['name'] || row['Name'] || row['中文名稱'];
                                if(c && n) dictionary[c.trim()] = n.trim();
                            });
                        }
                    }

                    processData(drugData, atcMap, dictionary);
                    loading.value = false;
                })
                .catch(err => {
                    console.error(err);
                    error.value = "資料載入失敗，請檢查網路或 Google Sheet 連結設定。";
                    loading.value = false;
                });
            };

            const processData = (rawData, atcMap, dict) => {
                dict = dict || {};

                let processed = rawData.map(row => {
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    if(!code) return null;
                    
                    if (code.length !== 6) return null;
                    if (code.startsWith('653')) return null;

                    const genericName = row['學名'] || '';
                    const tradeName = row['商品名(英文)'] || row['商品名'] || '無商品名';

                    if (tradeName.includes('贈') || genericName.includes('贈')) return null;

                    const mapData = atcMap[code] || { atc: '', price: '', sub1: '', sub2: '', orderNote: '' };
                    const atc = mapData.atc;
                    const selfPayPrice = mapData.price;
                    const sub1 = mapData.sub1;
                    const sub2 = mapData.sub2;
                    const orderNote = mapData.orderNote;

                    const rawNhi = row['健保碼'] ? row['健保碼'].trim() : '';
                    const nhiCode = rawNhi || '-';
                    const isSelfPay = (nhiCode === '-');

                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                    const status1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const status2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    let isDiscontinued = (status1 === 'Y' || status2 === 'Y') && !(status1 === 'N' || status2 === 'N');
                    let isOutOfStock = (status1 === 'C' || status2 === 'C') && !isDiscontinued;

                    let atcMain = '', atcSub = '', atcGroup = '', atcSubSub = '';
                    if (atc.length >= 1) { const c1 = atc.substring(0, 1); atcMain = dict[c1] || `分類 ${c1}`; }
                    if (atc.length >= 3) { const c3 = atc.substring(0, 3); atcSub = dict[c3] || c3; }
                    if (atc.length >= 4) { const c4 = atc.substring(0, 4); atcGroup = dict[c4] || c4; }
                    if (atc.length >= 5) { const c5 = atc.substring(0, 5); atcSubSub = dict[c5] || c5; }

                    return {
                        code, nhiCode, isSelfPay, selfPayPrice, sub1, sub2, orderNote,
                        genericName, tradeName, 
                        indication: row['適應症']||row['臨床用途']||'', dosage: row['用量用法']||'', sideEffect: row['副作用']||'',
                        
                        patientNote: row['民眾注意事項']||'', 
                        renalNote: row['劑量調整']||'', components: row['藥品成分']||'',
                        
                        pregCategory: row['懷孕分級'] ? row['懷孕分級'].trim() : '',
                        precautionEng: row['藥品注意事項(英文)'] ? row['藥品注意事項(英文)'].trim() : '',
                        warning: row['警語'] ? row['警語'].trim() : '',
                        warningEng: row['警語(英文)'] ? row['警語(英文)'].trim() : '',
                        profNote: row['醫護用藥須知'] ? row['醫護用藥須知'].trim() : '',
                        contraindication: row['禁忌'] ? row['禁忌'].trim() : '',

                        highAlert: row['高警訊藥品'], isHighAlert: (row['高警訊藥品'] === 'Y'), 
                        isDiscontinued, isOutOfStock,
                        imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                        leafletLink: row['超連結']||'', atcCode: atc, atcMain, atcMainCode: atc.substring(0,1), 
                        atcSub, atcSubCode: atc.substring(0,3), atcGroup, atcGroupCode: atc.substring(0,4), atcSubSub, atcSubSubCode: atc.substring(0,5)
                    };
                }).filter(d => d !== null);

                drugs.value = processed;
                fuse = new Fuse(processed, fuseOptions);
                buildAtcTree(processed);
            };

            const buildAtcTree = (data) => {
                const groups = {}; 
                data.forEach(d => {
                    if (d.atcMainCode && d.atcMain) {
                        if (!groups[d.atcMainCode]) {
                            groups[d.atcMainCode] = { code: d.atcMainCode, name: d.atcMain, subs: {} };
                        }
                        
                        if (d.atcSubCode && d.atcSub) {
                            if (!groups[d.atcMainCode].subs[d.atcSubCode]) {
                                groups[d.atcMainCode].subs[d.atcSubCode] = { 
                                    code: d.atcSubCode, 
                                    name: d.atcSub, 
                                    count: 0,
                                    subsubs: {} 
                                };
                            }
                            groups[d.atcMainCode].subs[d.atcSubCode].count++;

                            if (d.atcGroupCode && d.atcGroup) {
                                let subNode = groups[d.atcMainCode].subs[d.atcSubCode];
                                if (!subNode.subsubs[d.atcGroupCode]) {
                                    subNode.subsubs[d.atcGroupCode] = {
                                        code: d.atcGroupCode,
                                        name: d.atcGroup,
                                        count: 0
                                    };
                                }
                                subNode.subsubs[d.atcGroupCode].count++;
                            }
                        }
                    }
                });
                atcGroups.value = Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
            };
            
            const outOfStockDrugs = computed(() => {
                return drugs.value
                    .filter(d => d.isOutOfStock)
                    .sort((a, b) => (a.tradeName || '').localeCompare(b.tradeName || '')); 
            });
            
           const filteredDrugs = computed(() => {
                let result = [];
                if (keyword.value) {
                    const k = keyword.value.trim();
                    if (fuse) {
                        const searchResults = fuse.search(k);
                        result = searchResults.map(res => res.item);
                    }
                } 
                else if (filterCategory.value) {
                    result = drugs.value.filter(d => d.atcCode.startsWith(filterCategory.value));
                } else {
                    return [];
                }

                return result.sort((a, b) => {
                    if (a.atcGroupCode < b.atcGroupCode) return -1;
                    if (a.atcGroupCode > b.atcGroupCode) return 1;
                    if (a.atcSubSubCode < b.atcSubSubCode) return -1;
                    if (a.atcSubSubCode > b.atcSubSubCode) return 1;
                    const nameA = (a.genericName || '').toLowerCase();
                    const nameB = (b.genericName || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    if (a.isDiscontinued !== b.isDiscontinued) {
                        return a.isDiscontinued ? 1 : -1;
                    }
                    return 0;
                });
            });

            const groupedDrugs = computed(() => {
                const list = filteredDrugs.value;
                if (keyword.value) {
                    return [{ code: 'SEARCH', name: `搜尋結果 (${list.length} 筆)`, drugs: list }];
                }
                const groups = {};
                list.forEach(drug => {
                    let groupCode = drug.atcGroupCode || 'Other';
                    let groupName = drug.atcGroup || drug.atcSubSub || groupCode; 

                    if (!groups[groupCode]) {
                        groups[groupCode] = { code: groupCode, name: groupName, drugs: [] };
                    }
                    groups[groupCode].drugs.push(drug);
                });
                return Object.values(groups).sort((a, b) => a.code.localeCompare(b.code));
            });

            const onSearchInput = () => {
                if(keyword.value) { viewMode.value = 'result_list'; filterCategory.value = ''; } else { viewMode.value = 'home'; }
            };

            const selectMajorCategory = (cat) => {
                selectedMajor.value = { ...cat, subs: Object.values(cat.subs).sort((a,b) => a.code.localeCompare(b.code)) };
                viewMode.value = 'minor_list';
            };

            const selectMinorCategory = (sub) => {
                if (['J01', 'L01'].includes(sub.code)) {
                    const sortedSubsubs = Object.values(sub.subsubs).sort((a,b) => a.code.localeCompare(b.code));
                    selectedMinor.value = { ...sub, subsubs: sortedSubsubs };
                    viewMode.value = 'sub_minor_list';
                } else {
                    filterCategory.value = sub.code;
                    currentCategoryName.value = sub.name;
                    viewMode.value = 'result_list';
                }
            };

            const selectSubMinorCategory = (subsub) => {
                filterCategory.value = subsub.code;
                currentCategoryName.value = subsub.name;
                viewMode.value = 'result_list';
            };
            
            const backToMinorList = () => {
                if (filterCategory.value.length === 4) {
                    viewMode.value = 'sub_minor_list';
                } else {
                    viewMode.value = 'minor_list';
                }
                filterCategory.value = ''; 
                currentCategoryName.value = '';
            };

            const goToCategory = (level, drug) => {
                closeDetail(); // 1. 關閉詳情視窗
                keyword.value = ''; // 2. 強制清空搜尋關鍵字

                // 1. 先定位到主分類 (Major)
                const mainGroup = atcGroups.value.find(g => g.code === drug.atcMainCode);
                if (!mainGroup) {
                    alert('查無此分類資料');
                    return;
                }
                selectMajorCategory(mainGroup);
                if (level === 'main') return;

                // 2. 定位到子分類 (Minor)
                const subGroup = selectedMajor.value.subs.find(s => s.code === drug.atcSubCode);
                if (!subGroup) return;
                selectMinorCategory(subGroup);
                if (level === 'sub') return;

                // 3. 定位到細分類 (Sub-Sub)
                if (level === 'subsub') {
                    if (['J01', 'L01'].includes(drug.atcSubCode)) {
                        const targetCode = drug.atcGroupCode;
                        const targetName = drug.atcGroup; 
                        selectSubMinorCategory({ code: targetCode, name: targetName });
                    } else {
                        const targetCode = drug.atcSubSubCode || drug.atcGroupCode;
                        filterCategory.value = targetCode;
                        currentCategoryName.value = drug.atcSubSub || drug.atcGroup;
                    }
                }
            };

            const resetToHome = () => { keyword.value = ''; filterCategory.value = ''; viewMode.value = 'home'; };

            const searchNhiPrice = (code) => {
                navigator.clipboard.writeText(code).then(() => {
                    if(confirm(`健保碼 ${code} 已複製！前往健保署網站？`)) window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank');
                }).catch(() => window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank'));
            };

            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 
            
            const openSubstitute = (subCode) => {
                if (!subCode) return;
                const targetDrug = drugs.value.find(d => d.code === subCode);
                if (targetDrug) {
                    selectedDrug.value = targetDrug;
                } else {
                    alert(`找不到替代藥品代碼：${subCode} 的資料`);
                }
            };

            onMounted(() => { fetchAllData(); });

            return {
                keyword, filteredDrugs, groupedDrugs, selectedDrug, loading, error, 
                viewMode, atcGroups, selectedMajor, selectedMinor, filterCategory, currentCategoryName,
                onSearchInput, selectMajorCategory, selectMinorCategory, selectSubMinorCategory, resetToHome,
                openDetail, closeDetail, imageLoadError, searchNhiPrice,
                backToMinorList, outOfStockDrugs, openSubstitute, goToCategory
            };
        }
    }).mount('#app');
</script>
</body>
</html>


