<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>院內電子處方集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen relative flex flex-col">

    <header class="sticky top-0 bg-blue-600 p-4 shadow-md z-30">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-white text-lg font-bold flex items-center cursor-pointer" @click="resetToHome">
                <i class="fa-solid fa-hospital-user mr-2"></i> 藥品查詢系統
            </h1>
            <button v-if="keyword || filterCategory || viewMode !== 'home'" @click="resetToHome" class="text-xs bg-blue-500 hover:bg-blue-400 text-white px-3 py-1 rounded-full transition border border-blue-400">
                <i class="fa-solid fa-rotate-left mr-1"></i> 重置
            </button>
        </div>

        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            <input 
                v-model="keyword" 
                @input="onSearchInput"
                type="text" 
                placeholder="搜尋藥名、學名、代碼..." 
                class="w-full pl-10 pr-10 py-2 rounded-lg border-none focus:ring-2 focus:ring-blue-300 outline-none shadow-inner"
            >
            <button v-if="keyword" @click="keyword=''; onSearchInput()" class="absolute right-3 top-3 text-gray-400">
                <i class="fa-solid fa-times-circle"></i>
            </button>
        </div>

        <div v-if="viewMode === 'home' && !keyword" class="mt-3">
            <button @click="viewMode = 'major_list'" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center transition shadow-sm border border-blue-500">
                <i class="fa-solid fa-layer-group mr-2"></i> 藥理分類查詢
            </button>
        </div>
        
        <div v-if="(viewMode === 'result_list' || viewMode === 'sub_minor_list') && filterCategory" class="mt-2 text-white text-xs flex items-center overflow-hidden">
            <span class="opacity-70">分類：</span>
            <span class="font-bold truncate ml-1 bg-blue-800 px-2 py-0.5 rounded">{{ currentCategoryName }}</span>
        </div>
    </header>

    <main class="flex-1 p-3 safe-area-bottom overflow-y-auto bg-gray-50">
        
        <div v-if="loading" class="text-center py-20 text-gray-500">
            <div class="loader"></div>
            <p>正在同步資料庫...</p>
        </div>

        <div v-if="error" class="text-center py-20 text-red-500 px-4">
            <i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i>
            <p>{{ error }}</p>
        </div>

        <div v-if="!loading && !error && viewMode === 'home' && !keyword" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <div class="bg-gray-100 p-6 rounded-full mb-4">
                <i class="fa-solid fa-magnifying-glass text-4xl text-gray-300"></i>
            </div>
            <p class="font-bold text-gray-500">請輸入關鍵字搜尋</p>
            <p class="text-sm mt-1">或是點擊上方按鈕依分類瀏覽</p>
        </div>

        <div v-if="viewMode === 'major_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <h3 class="font-bold text-gray-700">藥理主分類</h3>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="cat in atcGroups" :key="cat.code" 
                     @click="selectMajorCategory(cat)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-blue-50 transition">
                    <div class="flex items-center">
                        <span class="font-bold text-gray-800 text-lg">{{ cat.name }}</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'minor_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <button @click="viewMode = 'major_list'" class="text-blue-600 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-arrow-left mr-1"></i> 返回主分類
                </button>
                <span class="text-xs text-gray-500 font-bold">{{ selectedMajor.name }}</span>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="sub in selectedMajor.subs" :key="sub.code" 
                     @click="selectMinorCategory(sub)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-indigo-50 transition">
                    <div class="flex items-center">
                        <span class="text-gray-800 font-medium">{{ sub.name }}</span>
                    </div>
                    <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{{ sub.count }} 筆</span>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'sub_minor_list'" class="animate-slide-up">
            <div class="flex items-center justify-between mb-3 px-1">
                <button @click="viewMode = 'minor_list'" class="text-blue-600 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-arrow-left mr-1"></i> 返回子分類
                </button>
                <span class="text-xs text-gray-500 font-bold">{{ selectedMinor.name }}</span>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div v-for="subsub in selectedMinor.subsubs" :key="subsub.code" 
                     @click="selectSubMinorCategory(subsub)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:bg-green-50 transition">
                    <div class="flex items-center">
                        <span class="text-gray-800 font-medium">{{ subsub.name }}</span>
                    </div>
                    <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{{ subsub.count }} 筆</span>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'result_list'" class="animate-slide-up">
            <div v-if="groupedDrugs.length === 0" class="text-center py-20 text-gray-400">
                <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                <p>找不到符合條件的藥品</p>
            </div>

            <div v-for="group in groupedDrugs" :key="group.code" class="mb-4">
                
                <div v-if="filterCategory" class="relative bg-gray-100 border-l-4 border-blue-500 px-3 py-2 text-sm font-bold text-gray-700 shadow-sm flex items-center mb-2 rounded-r">
                    <span class="bg-gray-600 text-white text-[10px] px-1.5 py-0.5 rounded mr-2 font-mono">{{ group.code }}</span>
                    <span>{{ group.name }}</span>
                </div>
                <div v-else class="px-2 mb-2 text-gray-500 text-xs font-bold">
                    {{ group.name }}
                </div>

                <div 
                    v-for="drug in group.drugs" 
                    :key="drug.code" 
                    @click="openDetail(drug)"
                    class="bg-white rounded-xl p-3 mb-3 card-shadow border border-gray-100 active:bg-blue-50 transition-colors cursor-pointer relative overflow-hidden"
                    :class="{'opacity-60': drug.isDiscontinued}"
                >
                    <div class="absolute top-0 right-0 flex">
                        <span v-if="drug.isHighAlert" class="bg-red-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg shadow-sm">高警訊</span>
                        <span v-if="drug.isDiscontinued" class="bg-gray-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">已停用</span>
                        <span v-if="drug.isOutOfStock" class="bg-orange-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg ml-1 shadow-sm">缺貨中</span>
                    </div>

                    <div class="flex items-start mt-2">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 mr-3 overflow-hidden border flex items-center justify-center">
                            <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                            <i v-else class="fa-solid fa-pills text-gray-300 text-2xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-base leading-tight mb-1 truncate pr-14" :class="drug.isDiscontinued ? 'text-gray-500 line-through' : 'text-blue-800'">
                                {{ drug.tradeName }}
                            </h3>
                            <p class="text-gray-500 text-xs font-mono mb-1 truncate">{{ drug.genericName }}</p>
                            <p class="text-gray-800 text-xs line-clamp-2 bg-gray-50 p-1 rounded">{{ drug.indication }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-0 sm:p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-[85vh] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up">
            
            <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                <h2 class="font-bold text-lg truncate pr-4" :class="selectedDrug.isDiscontinued ? 'text-gray-500 line-through' : 'text-gray-800'">
                    {{ selectedDrug.tradeName }}
                </h2>
                <button @click="closeDetail" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-5">
                <div v-if="selectedDrug.isDiscontinued" class="bg-gray-100 border-l-4 border-gray-500 p-3 rounded text-gray-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-ban mr-2"></i> 此藥品已停用
                </div>
                <div v-else-if="selectedDrug.isOutOfStock" class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded text-orange-700 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-box-open mr-2"></i> 此藥品目前缺貨中
                </div>

                <div class="w-full bg-white rounded-xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[150px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-64 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-10 flex flex-col items-center">
                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                        <span>無圖片資料</span>
                    </div>
                </div>

                <section v-if="selectedDrug.atcCode" class="bg-indigo-50 rounded-xl p-3 border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-2">藥理分類</h3>
                    <div class="space-y-2">
                        <div v-if="selectedDrug.atcMain" class="flex items-center gap-2 p-1">
                            <span class="bg-indigo-200 text-indigo-800 text-xs px-2 py-0.5 rounded-full font-bold">主分類</span>
                            <span class="text-sm font-bold text-indigo-900">{{ selectedDrug.atcMain }}</span>
                        </div>
                        <div v-if="selectedDrug.atcSub" class="flex items-center gap-2 ml-2 border-l-2 border-indigo-200 pl-2 p-1">
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-bold">子分類</span>
                            <span class="text-sm text-indigo-800">{{ selectedDrug.atcSub }}</span>
                        </div>
                        <div v-if="selectedDrug.atcSubSub" class="flex items-center gap-2 ml-4 border-l-2 border-green-200 pl-2 p-1">
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-bold">細分類</span>
                            <span class="text-sm text-green-800">{{ selectedDrug.atcSubSub }}</span>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 border-b pb-1">基本資料</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><span class="text-xs text-gray-500 block">學名</span><span class="text-gray-900 font-medium select-all">{{ selectedDrug.genericName }}</span></div>
                        <div class="grid grid-cols-2 gap-2">
                             <div><span class="text-xs text-gray-500 block">院內代碼</span><span class="text-gray-900 select-all">{{ selectedDrug.code }}</span></div>
                             <div>
                                <span class="text-xs text-gray-500 block">健保碼 (點擊查價)</span>
                                <a v-if="selectedDrug.nhiCode && selectedDrug.nhiCode !== '-'" href="#" @click.prevent="searchNhiPrice(selectedDrug.nhiCode)" class="text-blue-600 font-bold hover:text-blue-800 underline flex items-center select-all">
                                    {{ selectedDrug.nhiCode }}<i class="fa-solid fa-magnifying-glass-dollar ml-1 text-xs"></i>
                                </a>
                                <span v-else class="text-gray-900">-</span>
                            </div>
                        </div>
                         <div v-if="selectedDrug.components"><span class="text-xs text-gray-500 block">成份</span><span class="text-gray-900 text-sm">{{ selectedDrug.components }}</span></div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-2 border-b border-blue-100 pb-1">臨床用途</h3>
                    <div class="space-y-3">
                        <div><span class="font-bold text-gray-700 text-sm">適應症</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.indication }}</p></div>
                        <div><span class="font-bold text-gray-700 text-sm">用法用量</span><p class="text-gray-800 text-sm mt-1 leading-relaxed">{{ selectedDrug.dosage }}</p></div>
                        <div v-if="selectedDrug.renalNote" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><span class="font-bold text-yellow-800 text-sm">劑量調整</span><p class="text-yellow-900 text-sm mt-1">{{ selectedDrug.renalNote }}</p></div>
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-bold text-green-600 uppercase tracking-wider mb-2 border-b border-green-100 pb-1">衛教資訊</h3>
                    <div class="space-y-3">
                        <div v-if="selectedDrug.sideEffect"><span class="font-bold text-gray-700 text-sm">副作用</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.sideEffect }}</p></div>
                         <div v-if="selectedDrug.patientNote"><span class="font-bold text-gray-700 text-sm">注意事項</span><p class="text-gray-600 text-sm mt-1">{{ selectedDrug.patientNote }}</p></div>
                    </div>
                </section>
            </div>
            
            <div class="p-3 border-t bg-gray-50 flex gap-2">
                <a v-if="selectedDrug.leafletLink" :href="selectedDrug.leafletLink" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg text-center font-bold text-sm shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-file-pdf mr-2 text-red-500"></i> 仿單
                </a>
                <button @click="closeDetail" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-center font-bold text-sm shadow-md active:bg-blue-700">確定</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // ============== 資料來源設定 ==============
    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const ATC_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMhr-Ocv4uEN6virOvzsEY-c1-tCEs-e1lB-fvB9d2U2XCtcDaHnLnob_Vu6Ktjce4YErY9y6FuaxD/pub?output=csv';
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 
    // ==========================================

    // *** ATC 字典 ***
    const ATC_DICT = {
        'A': '消化道及代謝', 'A01': '口腔科製劑', 'A02': '胃酸相關疾病用藥', 'A03': '功能性腸胃道疾病用藥', 'A04': '止吐藥及止噁心藥',
        'A04AA': '止吐藥：血清素(5HT3)拮抗劑', 'A04AD': '止吐藥：P物質/NK1受體拮抗劑',
        'A05': '膽汁與肝臟治療劑', 'A06': '便秘用藥', 'A07': '止瀉藥、腸道抗發炎/抗感染劑', 'A08': '抗肥胖製劑', 'A09': '消化劑(含酶)',
        'A10': '糖尿病用藥', 'A10AB': '胰島素(速效)', 'A10AC': '胰島素(中效)', 'A10AD': '胰島素(預混型)', 'A10AE': '胰島素(長效)', 'A10AF': '胰島素(吸入)',
        'A10BA': '雙胍類(Metformin)', 'A10BB': '磺胺類(SU)', 'A10BD': '口服複方降糖藥', 'A10BF': 'α-葡萄糖苷酶抑制劑', 'A10BG': 'TZD類(胰島素增敏劑)', 
        'A10BH': 'DPP-4抑制劑', 'A10BJ': 'GLP-1類似物', 'A10BK': 'SGLT2抑制劑',
        'A11': '維生素', 'A12': '礦物質補充劑', 'A13': '補品', 'A14': '系統性同化劑', 'A15': '食慾興奮劑', 'A16': '其他消化代謝藥',
        'B': '血液及造血器官', 'B01': '抗血栓藥', 'B01AA': '維生素K拮抗劑', 'B01AB': '肝素類', 'B01AC': '抗血小板藥', 'B01AD': '酵素類', 'B01AE': '直接凝血酶抑制劑', 'B01AF': '直接X因子抑制劑',
        'B02': '抗出血藥', 'B02AA': '胺基酸類', 'B02AB': '蛋白酶抑制劑', 'B02BA': '維生素K', 'B02BD': '凝血因子',
        'B03': '抗貧血製劑', 'B03AA': '鐵劑(二價)', 'B03AC': '鐵劑(三價)', 'B03BA': '維生素B12', 'B03BB': '葉酸及其衍生物', 'B03XA': '其他抗貧血藥(EPO)',
        'B05': '血液替代品和灌注液', 'B06': '其他血液製劑',
        'C': '心血管系統', 'C01': '心臟治療', 'C01AA': '強心苷類', 'C01BA': '抗心律不整藥(Ia)', 'C01BB': '抗心律不整藥(Ib)', 'C01BC': '抗心律不整藥(Ic)', 'C01BD': '抗心律不整藥(III)', 'C01DA': '有機硝酸鹽類', 'C01EB': '其他心臟製劑',
        'C02': '抗高血壓藥', 'C02AB': '中樞作用降壓藥', 'C02CA': 'α-阻斷劑', 'C02DB': '肼類衍生物',
        'C03': '利尿劑', 'C03AA': 'Thiazide類', 'C03BA': '磺胺類(Loop利尿劑)', 'C03CA': '保鉀利尿劑', 'C03DA': '保鉀利尿劑',
        'C04': '周邊血管擴張劑', 'C05': '血管保護劑',
        'C07': 'β-阻斷劑', 'C07AA': 'β-阻斷劑(非選擇性)', 'C07AB': 'β-阻斷劑(選擇性)', 'C07AG': 'α及β-阻斷劑',
        'C08': '鈣離子通道阻斷劑', 'C08CA': 'DHP類(血管選擇性)', 'C08DA': 'Phenylalkylamine類', 'C08DB': 'Benzothiazepine類',
        'C09': 'RAS系統作用藥', 'C09AA': 'ACEI單方', 'C09BA': 'ACEI+利尿劑', 'C09BB': 'ACEI+CCB', 'C09CA': 'ARB單方', 'C09DA': 'ARB+利尿劑', 'C09DB': 'ARB+CCB', 'C09DX': 'ARB其他複方',
        'C10': '血脂修飾劑', 'C10AA': 'Statin類', 'C10AB': 'Fibrate類', 'C10AC': '膽汁酸結合樹脂', 'C10AD': '菸鹼酸類', 'C10AX': '其他降血脂藥', 'C10BA': 'Statin+其他',
        'D': '皮膚科用藥', 'D01': '皮膚抗黴菌劑', 'D02': '潤膚劑', 'D03': '傷口潰瘍製劑', 'D04': '止癢劑', 'D05': '抗乾癬藥', 'D06': '皮膚抗生素',
        'D07': '皮膚類固醇', 'D07AA': '弱效(I級)', 'D07AB': '中效(II級)', 'D07AC': '強效(III級)', 'D07AD': '超強效(IV級)',
        'D08': '消毒劑', 'D10': '抗痤瘡製劑', 'D11': '其他皮膚科製劑',
        'G': '泌尿生殖系統', 'G01': '婦科抗感染藥', 'G02': '其他婦科藥', 'G03': '性激素', 'G03AA': '口服避孕藥', 'G03BA': '雄性激素', 'G03CA': '天然雌激素', 'G03DA': '孕激素', 
        'G04': '泌尿科藥物', 'G04BD': '解痙藥', 'G04BE': '勃起功能障礙藥', 'G04CA': '良性攝護腺肥大(α-阻斷)', 'G04CB': '良性攝護腺肥大(5α-還原酶抑制)',
        'H': '全身性賀爾蒙', 'H01': '腦下垂體激素', 'H02': '皮質類固醇', 'H02AB': '糖皮質類固醇', 'H03': '甲狀腺治療', 'H03AA': '甲狀腺激素', 'H03BB': '抗甲狀腺藥',
        'J': '全身性抗感染劑', 'J01': '全身性抗菌劑', 'J01AA': '四環黴素類', 'J01CA': '廣譜青黴素', 'J01CE': '青黴素(對β-lactamase敏感)', 'J01CF': '青黴素(耐β-lactamase)', 'J01CR': '青黴素複方', 
        'J01DB': '頭孢菌素(第一代)', 'J01DC': '頭孢菌素(第二代)', 'J01DD': '頭孢菌素(第三代)', 'J01DE': '頭孢菌素(第四代)', 'J01DF': 'Monobactams', 'J01DH': 'Carbapenems', 
        'J01EE': '磺胺類複方', 'J01FA': '巨環類', 'J01FF': '林可黴素類', 'J01GB': 'Aminoglycosides', 'J01MA': 'Fluoroquinolones', 'J01XA': '醣肽類', 'J01XD': 'Imidazoles',
        'J02': '全身性抗黴菌劑', 'J02AC': 'Triazole類', 'J04': '抗結核病藥', 
        'J05': '抗病毒藥', 'J05AB': '核苷類(不含HIV)', 'J05AE': '蛋白酶抑制劑', 'J05AF': '核苷類反轉錄酶抑制劑', 'J05AG': '非核苷類反轉錄酶抑制劑', 'J05AJ': 'Integrase抑制劑', 'J05AR': '抗HIV複方',
        'J06': '免疫血清', 'J07': '疫苗',
        'L': '抗腫瘤及免疫調節', 'L01': '抗腫瘤藥', 'L01AA': '氮芥類', 'L01BA': '葉酸類似物', 'L01BB': '嘌呤類似物', 'L01BC': '嘧啶類似物', 'L01CA': '長春花生物鹼', 'L01CD': '紫杉醇類', 'L01DB': 'Anthracyclines', 'L01XC': '單株抗體', 'L01XE': '蛋白激酶抑制劑', 'L01XX': '其他抗腫瘤藥',
        'L02': '內分泌療法', 'L02AE': 'GnRH類似物', 'L02BA': '抗雌激素', 'L02BB': '抗雄性素', 'L03': '免疫刺激劑', 'L03AA': '群落刺激因子', 'L03AB': '干擾素',
        'L04': '免疫抑制劑', 'L04AA': '選擇性免疫抑制劑', 'L04AB': 'TNF-α抑制劑', 'L04AC': 'Interleukin抑制劑', 'L04AD': 'Calcineurin抑制劑', 'L04AX': '其他免疫抑制劑',
        'M': '肌肉骨骼系統', 'M01': '抗發炎抗風濕藥', 'M01AA': 'Butylpyrazolidines', 'M01AB': '醋酸衍生物', 'M01AC': 'Oxicams', 'M01AE': '丙酸衍生物', 'M01AH': 'Coxibs', 'M01AX': '其他NSAID',
        'M02': '外用關節肌肉痛藥', 'M03': '肌肉鬆弛劑', 'M03AB': 'Choline衍生物', 'M03AC': '其他季銨化合物', 'M03AX': '其他周邊作用', 'M03BX': '中樞作用肌肉鬆弛劑',
        'M04': '抗痛風藥', 'M04AA': '抑制尿酸生成', 'M04AB': '促進尿酸排泄', 'M05': '骨骼疾病藥物', 'M05BA': '雙磷酸鹽類', 'M05BX': '其他骨骼藥物',
        'N': '神經系統', 'N01': '麻醉劑', 'N01AB': '鹵化烴類', 'N01AF': 'Barbiturates', 'N01AH': 'Opioid麻醉劑', 'N01AX': '其他全麻藥', 'N01BB': '醯胺類局麻藥',
        'N02': '止痛藥', 'N02AA': '天然鴉片生物鹼', 'N02AB': 'Phenylpiperidine', 'N02AX': '其他鴉片類', 'N02BA': '水楊酸類', 'N02BE': 'Anilides',
        'N03': '抗癲癇藥', 'N03AA': 'Barbiturates', 'N03AB': 'Hydantoin', 'N03AF': 'Carboxamide', 'N03AG': '脂肪酸衍生物', 'N03AX': '其他抗癲癇藥',
        'N04': '抗帕金森氏症', 'N04AA': '三級胺', 'N04BA': 'Dopa及其衍生物', 'N04BC': '多巴胺激動劑', 'N04BD': 'MAO-B抑制劑',
        'N05': '精神安定劑', 'N05AA': 'Phenothiazine', 'N05AB': 'Piperazine', 'N05AD': 'Butyrophenone', 'N05AH': 'Diazepines/Oxepines', 'N05AL': 'Benzamides', 'N05AX': '其他抗精神病藥', 'N05BA': 'Benzodiazepine(抗焦慮)', 'N05CD': 'Benzodiazepine(安眠)', 'N05CF': 'BZD相關藥物',
        'N06': '精神興奮劑', 'N06AA': 'TCA(三環抗鬱)', 'N06AB': 'SSRI', 'N06AX': '其他抗憂鬱藥', 'N06BA': '中樞擬交感神經', 'N06DA': '膽鹼酯酶抑制劑', 'N06DX': '其他失智症藥',
        'N07': '其他神經藥物', 'N07AA': '抗膽鹼酯酶', 'N07BB': '酒精依賴用藥',
        'P': '抗寄生蟲產品', 'P01': '抗原蟲藥', 'P02': '驅蟲藥', 'P03': '殺外寄生蟲藥',
        'R': '呼吸系統', 'R01': '鼻腔製劑', 'R02': '咽喉製劑', 'R03': '阻塞性呼吸道用藥', 'R03AC': '選擇性β2激動劑', 'R03AK': '複方', 'R03BA': 'Glucocorticoids(吸入)', 'R03BB': '抗膽鹼藥', 'R03DA': 'Xanthines', 'R03DC': 'Leukotriene受體拮抗劑',
        'R05': '咳嗽感冒製劑', 'R05CB': '黏液溶解劑', 'R05DA': '鴉片生物鹼(止咳)',
        'R06': '抗組織胺', 'R06AA': 'Aminoalkyl ethers', 'R06AB': 'Substituted alkylamines', 'R06AE': 'Piperazine衍生物', 'R06AX': '其他抗組織胺',
        'S': '感覺器官', 'S01': '眼科', 'S01AA': '抗生素', 'S01BA': '皮質類固醇', 'S01CA': '類固醇+抗生素', 'S01EA': '擬交感神經藥', 'S01EB': '副交感神經藥', 'S01EC': '碳酸酐酶抑制劑', 'S01ED': 'β-阻斷劑', 'S01EE': '前列腺素類似物', 'S01FA': '抗膽鹼藥', 'S01GX': '抗過敏藥', 'S01LA': '抗新生血管製劑',
        'S02': '耳科', 'S03': '眼耳製劑',
        'V': '其他', 'V01': '過敏原', 'V03': '解毒劑', 'V03AB': '解毒劑', 'V03AE': '高血鉀治療藥', 'V03AF': '解毒劑(抗腫瘤藥)', 'V04': '診斷試劑', 'V08': '顯影劑'
    };

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');
            
            // 視圖狀態
            const viewMode = ref('home'); 
            const filterCategory = ref(''); 
            const currentCategoryName = ref('');
            
            const atcGroups = ref([]); 
            const selectedMajor = ref(null); 
            const selectedMinor = ref(null); 

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (r) => resolve(r.data), error: (e) => reject(e) });
            });

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([fetchCsv(DRUG_DATA_URL), fetchCsv(ATC_DATA_URL)])
                    .then(([drugData, atcData]) => {
                        const atcMap = {};
                        atcData.forEach(row => {
                            if(row['藥品代碼']) atcMap[row['藥品代碼'].trim()] = row['ATC碼'] ? row['ATC碼'].trim().toUpperCase() : '';
                        });
                        processData(drugData, atcMap);
                        loading.value = false;
                    })
                    .catch(err => {
                        error.value = "資料載入失敗。";
                        loading.value = false;
                    });
            };

            const processData = (rawData, atcMap) => {
                let processed = rawData.map(row => {
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    if(!code) return null;
                    
                    const isValidCode = /^[A-Za-z]{4}\d{2}$/.test(code);
                    if (!isValidCode) return null;

                    const atc = atcMap[code] || '';
                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                    
                    const status1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const status2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    let isDiscontinued = (status1 === 'Y' || status2 === 'Y') && !(status1 === 'N' || status2 === 'N');
                    let isOutOfStock = (status1 === 'C' || status2 === 'C') && !isDiscontinued && !(status1 === 'N' || status2 === 'N');

                    let atcMain = '', atcSub = '', atcSubSub = '';
                    if (atc.length >= 1) {
                        const c1 = atc.substring(0, 1);
                        atcMain = ATC_DICT[c1] || `分類 ${c1}`; 
                    }
                    if (atc.length >= 3) {
                        const c3 = atc.substring(0, 3);
                        atcSub = ATC_DICT[c3] || c3; 
                    }
                    if (atc.length >= 5) {
                        const c5 = atc.substring(0, 5);
                        atcSubSub = ATC_DICT[c5] || c5; 
                    }

                    return {
                        code, nhiCode: row['健保碼']||'-', genericName: row['學名']||'', tradeName: row['商品名(英文)']||row['商品名']||'無商品名',
                        indication: row['適應症']||row['臨床用途']||'', dosage: row['用量用法']||'', sideEffect: row['副作用']||'',
                        patientNote: row['民眾注意事項']||row['警語']||'', renalNote: row['劑量調整']||'', components: row['藥品成分']||'',
                        pregCategory: row['懷孕分級']||'', highAlert: row['高警訊藥品'], 
                        isHighAlert: (row['高警訊藥品'] === 'Y'), isDiscontinued, isOutOfStock,
                        imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                        leafletLink: row['超連結']||'', atcCode: atc, 
                        atcMain, atcMainCode: atc.substring(0,1), 
                        atcSub, atcSubCode: atc.substring(0,3),
                        atcSubSub, atcSubSubCode: atc.substring(0,5)
                    };
                }).filter(d => d !== null);

                drugs.value = processed;
                buildAtcTree(processed);
            };

            const buildAtcTree = (data) => {
                const groups = {}; 
                data.forEach(d => {
                    if (d.atcMainCode && d.atcMain) {
                        if (!groups[d.atcMainCode]) {
                            groups[d.atcMainCode] = { code: d.atcMainCode, name: d.atcMain, subs: {} };
                        }
                        if (d.atcSubCode && d.atcSub) {
                            if (!groups[d.atcMainCode].subs[d.atcSubCode]) {
                                groups[d.atcMainCode].subs[d.atcSubCode] = { 
                                    code: d.atcSubCode, name: d.atcSub, count: 0, 
                                    subsubs: {}, hasSubSub: false 
                                };
                            }
                            groups[d.atcMainCode].subs[d.atcSubCode].count++;
                            if (d.atcSubSubCode && d.atcSubSub) {
                                if (!groups[d.atcMainCode].subs[d.atcSubCode].subsubs[d.atcSubSubCode]) {
                                    groups[d.atcMainCode].subs[d.atcSubCode].subsubs[d.atcSubSubCode] = {
                                        code: d.atcSubSubCode, name: d.atcSubSub, count: 0
                                    };
                                }
                                groups[d.atcMainCode].subs[d.atcSubCode].subsubs[d.atcSubSubCode].count++;
                                groups[d.atcMainCode].subs[d.atcSubCode].hasSubSub = true;
                            }
                        }
                    }
                });
                atcGroups.value = Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
            };

            const filteredDrugs = computed(() => {
                let result = [];
                if (keyword.value) {
                    const k = keyword.value.toLowerCase().trim();
                    result = drugs.value.filter(d => 
                        (d.tradeName && d.tradeName.toLowerCase().includes(k)) ||
                        (d.genericName && d.genericName.toLowerCase().includes(k)) ||
                        (d.code && d.code.toLowerCase().includes(k)) ||
                        (d.indication && d.indication.toLowerCase().includes(k)) ||
                        (d.atcCode && d.atcCode.toLowerCase().includes(k))
                    );
                } else if (filterCategory.value) {
                    result = drugs.value.filter(d => d.atcCode.startsWith(filterCategory.value));
                } else {
                    return [];
                }
                return result.sort((a, b) => {
                    const getScore = (drug) => {
                        if (drug.isDiscontinued) return 3;
                        if (drug.isOutOfStock) return 2;
                        return 1;
                    };
                    return getScore(a) - getScore(b);
                });
            });

            const groupedDrugs = computed(() => {
                const list = filteredDrugs.value;
                if (keyword.value) {
                    return [{ code: 'SEARCH', name: `搜尋結果 (${list.length} 筆)`, drugs: list }];
                }
                const groups = {};
                list.forEach(drug => {
                    let groupCode = drug.atcSubSubCode || drug.atcSubCode || 'Other';
                    let groupName = ATC_DICT[groupCode] || groupCode; // 若無中文名則顯示代碼
                    if (!groups[groupCode]) {
                        groups[groupCode] = { code: groupCode, name: groupName, drugs: [] };
                    }
                    groups[groupCode].drugs.push(drug);
                });
                return Object.values(groups).sort((a, b) => a.code.localeCompare(b.code));
            });

            const onSearchInput = () => {
                if(keyword.value) { viewMode.value = 'result_list'; filterCategory.value = ''; } else { viewMode.value = 'home'; }
            };

            const selectMajorCategory = (cat) => {
                selectedMajor.value = { ...cat, subs: Object.values(cat.subs).sort((a,b) => a.code.localeCompare(b.code)) };
                viewMode.value = 'minor_list';
            };

            const selectMinorCategory = (sub) => {
                if (sub.count >= 10 && sub.hasSubSub) {
                    selectedMinor.value = { ...sub, subsubs: Object.values(sub.subsubs).sort((a,b) => a.code.localeCompare(b.code)) };
                    viewMode.value = 'sub_minor_list';
                } else {
                    filterCategory.value = sub.code;
                    currentCategoryName.value = sub.name;
                    viewMode.value = 'result_list';
                }
            };

            const selectSubMinorCategory = (subsub) => {
                filterCategory.value = subsub.code;
                currentCategoryName.value = subsub.name;
                viewMode.value = 'result_list';
            };

            const resetToHome = () => { keyword.value = ''; filterCategory.value = ''; viewMode.value = 'home'; };

            const searchNhiPrice = (code) => {
                navigator.clipboard.writeText(code).then(() => {
                    if(confirm(`健保碼 ${code} 已複製！前往健保署網站？`)) window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank');
                }).catch(() => window.open('https://info.nhi.gov.tw/INAE3000/INAE3000S01', '_blank'));
            };

            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 

            onMounted(() => { fetchAllData(); });

            return {
                keyword, filteredDrugs, groupedDrugs, selectedDrug, loading, error, 
                viewMode, atcGroups, selectedMajor, selectedMinor, filterCategory, currentCategoryName,
                onSearchInput, selectMajorCategory, selectMinorCategory, selectSubMinorCategory, resetToHome,
                openDetail, closeDetail, imageLoadError, searchNhiPrice
            };
        }
    }).mount('#app');
</script>
</body>
</html>
